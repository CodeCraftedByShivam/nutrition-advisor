<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard - Nutrition Advisor</title>
  <link rel="stylesheet" href="dashboard-style.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style>


</head>
<body>
  <!-- Navigation -->
  <nav class="navbar">
    <div class="nav-container">
      <div class="logo">
        <h2>ü•ó Nutrition Advisor</h2>
      </div>
      <div class="nav-items">
        <span id="welcomeText">Welcome!</span>
        <button onclick="logout()" class="btn btn-outline">Logout</button>
      </div>
    </div>
  </nav>

  <!-- Dashboard Content -->
  <div class="dashboard">
    <div class="container">
      
      <!-- Stats Cards -->
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-icon">üî•</div>
          <div class="stat-info">
            <h3 id="caloriesCount">0</h3>
            <p>Calories Today</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üçé</div>
          <div class="stat-info">
            <h3 id="mealsCount">0</h3>
            <p>Meals Logged</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üéØ</div>
          <div class="stat-info">
            <h3 id="goalProgress">0%</h3>
            <p>Daily Goal</p>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-icon">üìà</div>
          <div class="stat-info">
            <h3 id="streakCount">0</h3>
            <p>Day Streak</p>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="quick-actions">
        <h2>Quick Actions</h2>
        <div class="actions-grid">
          <button onclick="showAddMealModal()" class="action-btn">
            <span class="action-icon">üçΩÔ∏è</span>
            <span>Log Meal</span>
          </button>
          <button onclick="showNutritionAnalysis()" class="action-btn">
            <span class="action-icon">üìä</span>
            <span>View Analysis</span>
          </button>
          <button onclick="showGoalSetting()" class="action-btn">
            <span class="action-icon">üéØ</span>
            <span>Set Goals</span>
          </button>
          <button onclick="showProfile()" class="action-btn">
            <span class="action-icon">üë§</span>
            <span>My Profile</span>
          </button>
        </div>
      </div>

      <!-- Recent Meals -->
      <div class="recent-section">
        <h2>Today's Meals</h2>
        <div id="recentMeals" class="meals-list">
          <div class="empty-state">
            <p>No meals logged today. Start by adding your first meal!</p>
          </div>
        </div>
      </div>

    </div>
  </div>

  <!-- Add Meal Modal -->
<!-- Add Meal Modal -->
<div id="addMealModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h2>Log Your Meal</h2>
    <form id="addMealForm" class="meal-form">
      <div class="form-group">
        <label>Meal Type:</label>
        <select name="mealType" required>
          <option value="">Select meal type</option>
          <option value="breakfast">Breakfast</option>
          <option value="lunch">Lunch</option>
          <option value="dinner">Dinner</option>
          <option value="snack">Snack</option>
        </select>
      </div>
      
      <div class="form-group">
        <label>Search Food:</label>
        <input type="text" id="foodSearch" placeholder="e.g., Paneer, Rice, Dal, Apple" autocomplete="off" />
        <div id="foodSuggestions" class="suggestions"></div>
        <input type="hidden" name="foodId" id="selectedFoodId" />
        <input type="hidden" name="foodName" id="selectedFoodName" />
      </div>
      
      <div class="form-group">
        <label>Quantity:</label>
        <input type="text" name="quantity" placeholder="e.g., 1 cup, 200g, 2 rotis" required />
      </div>
      
      <div id="nutritionPreview" class="nutrition-preview" style="display:none;">
        <h4>Nutrition Info (per 100g):</h4>
        <div class="nutrition-grid">
          <span>Calories: <strong id="previewCalories">-</strong></span>
          <span>Protein: <strong id="previewProtein">-</strong>g</span>
          <span>Carbs: <strong id="previewCarbs">-</strong>g</span>
          <span>Fat: <strong id="previewFat">-</strong>g</span>
        </div>
      </div>
      
      <button type="submit" class="btn btn-primary btn-full">Add Meal</button>
    </form>
    <p id="mealMessage" class="message"></p>
  </div>
</div>
        
        <button type="submit" class="btn btn-primary btn-full">Add Meal</button>
      </form>
      <p id="mealMessage" class="message"></p>
    </div>
  </div>

  <!-- Nutrition Analysis Modal -->
<div id="analysisModal" class="modal">
  <div class="modal-content analysis-modal">
    <span class="close" onclick="closeAnalysisModal()">&times;</span>
    <h2>üìä Nutrition Analysis</h2>
    
    <!-- Date Filter -->
    <div class="analysis-filters">
      <label>Time Period:</label>
      <select id="periodFilter" onchange="loadAnalysis()">
        <option value="today">Today</option>
        <option value="week">This Week</option>
        <option value="month">This Month</option>
      </select>
    </div>
    
    <!-- Stats Overview -->
    <div class="analysis-stats">
      <div class="analysis-stat">
        <span class="stat-number" id="totalCaloriesAnalysis">0</span>
        <span class="stat-label">Total Calories</span>
      </div>
      <div class="analysis-stat">
        <span class="stat-number" id="avgCaloriesAnalysis">0</span>
        <span class="stat-label">Daily Average</span>
      </div>
      <div class="analysis-stat">
        <span class="stat-number" id="totalMealsAnalysis">0</span>
        <span class="stat-label">Meals Logged</span>
      </div>
    </div>
    
    <!-- Charts Container -->
    <div class="charts-container">
      <!-- Macros Pie Chart -->
      <div class="chart-section">
        <h3>Macronutrient Breakdown</h3>
        <canvas id="macrosChart" width="300" height="300"></canvas>
      </div>
      
      <!-- Daily Progress Chart -->
      <div class="chart-section">
        <h3>Daily Calorie Trend</h3>
        <canvas id="caloriesChart" width="400" height="200"></canvas>
      </div>
    </div>
    
    <!-- Recommendations -->
    <div class="recommendations">
      <h3>üí° Insights & Recommendations</h3>
      <div id="recommendationsList">
        <p>Loading recommendations...</p>
      </div>
    </div>
  </div>
</div>
<!-- User Profile Modal -->
<div id="profileModal" class="modal">
  <div class="modal-content profile-modal">
    <span class="close" onclick="closeProfileModal()">&times;</span>
    <h2>üë§ My Profile & Goals</h2>
    
    <!-- Profile Tabs -->
    <div class="profile-tabs">
      <button class="tab-btn active" onclick="switchTab('personal')">Personal Info</button>
      <button class="tab-btn" onclick="switchTab('goals')">Goals & Preferences</button>
    </div>
    
    <!-- Personal Information Tab -->
    <div id="personalTab" class="tab-content active">
      <form id="personalInfoForm" class="profile-form">
        <div class="form-row">
          <div class="form-group">
            <label>Full Name:</label>
            <input type="text" name="fullName" id="fullName" placeholder="Your full name" required />
          </div>
          <div class="form-group">
            <label>Age:</label>
            <input type="number" name="age" id="age" placeholder="25" min="13" max="100" required />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Gender:</label>
            <select name="gender" id="gender" required>
              <option value="">Select gender</option>
              <option value="male">Male</option>
              <option value="female">Female</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group">
            <label>Height (cm):</label>
            <input type="number" name="height" id="height" placeholder="170" min="100" max="250" required />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Current Weight (kg):</label>
            <input type="number" name="weight" id="weight" placeholder="70" min="30" max="300" step="0.1" required />
          </div>
          <div class="form-group">
            <label>Activity Level:</label>
            <select name="activityLevel" id="activityLevel" required>
              <option value="">Select activity level</option>
              <option value="sedentary">Sedentary (little/no exercise)</option>
              <option value="light">Light (1-3 days/week)</option>
              <option value="moderate">Moderate (3-5 days/week)</option>
              <option value="active">Active (6-7 days/week)</option>
              <option value="very_active">Very Active (2x/day, intense)</option>
            </select>
          </div>
        </div>
      </form>
    </div>
    
    <!-- Goals & Preferences Tab -->
    <div id="goalsTab" class="tab-content">
      <form id="goalsForm" class="profile-form">
        <div class="form-row">
          <div class="form-group">
            <label>Primary Goal:</label>
            <select name="primaryGoal" id="primaryGoal" required>
              <option value="">Select your goal</option>
              <option value="lose_weight">Lose Weight</option>
              <option value="maintain_weight">Maintain Weight</option>
              <option value="gain_weight">Gain Weight</option>
              <option value="build_muscle">Build Muscle</option>
              <option value="improve_health">Improve Health</option>
            </select>
          </div>
          <div class="form-group">
            <label>Target Weight (kg):</label>
            <input type="number" name="targetWeight" id="targetWeight" placeholder="65" min="30" max="300" step="0.1" />
          </div>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label>Diet Preference:</label>
            <select name="dietPreference" id="dietPreference">
              <option value="none">No specific diet</option>
              <option value="vegetarian">Vegetarian</option>
              <option value="vegan">Vegan</option>
              <option value="keto">Ketogenic</option>
              <option value="paleo">Paleo</option>
              <option value="mediterranean">Mediterranean</option>
              <option value="low_carb">Low Carb</option>
            </select>
          </div>
          <div class="form-group">
            <label>Weekly Weight Goal:</label>
            <select name="weeklyGoal" id="weeklyGoal">
              <option value="0">Maintain current weight</option>
              <option value="-0.25">Lose 0.25 kg/week</option>
              <option value="-0.5">Lose 0.5 kg/week</option>
              <option value="-0.75">Lose 0.75 kg/week</option>
              <option value="-1">Lose 1 kg/week</option>
              <option value="0.25">Gain 0.25 kg/week</option>
              <option value="0.5">Gain 0.5 kg/week</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label>Health Conditions:</label>
          <textarea name="healthConditions" id="healthConditions" placeholder="Any allergies, medical conditions, or dietary restrictions..." rows="3"></textarea>
        </div>
      </form>
    </div>
    
    <!-- Calculated Goals Display -->
    <div id="calculatedGoals" class="goals-display" style="display:none;">
      <h3>üìä Your Personalized Goals</h3>
      <div class="goals-grid">
        <div class="goal-item">
          <span class="goal-number" id="dailyCalories">0</span>
          <span class="goal-label">Daily Calories</span>
        </div>
        <div class="goal-item">
          <span class="goal-number" id="dailyProtein">0g</span>
          <span class="goal-label">Protein</span>
        </div>
        <div class="goal-item">
          <span class="goal-number" id="dailyCarbs">0g</span>
          <span class="goal-label">Carbs</span>
        </div>
        <div class="goal-item">
          <span class="goal-number" id="dailyFat">0g</span>
          <span class="goal-label">Fat</span>
        </div>
      </div>
    </div>
    
    <!-- Action Buttons -->
    <div class="profile-actions">
      <button type="button" onclick="calculateGoals()" class="btn btn-outline">Calculate Goals</button>
      <button type="button" onclick="saveProfile()" class="btn btn-primary">Save Profile</button>
    </div>
    
    <p id="profileMessage" class="message"></p>
  </div>
</div>

<!-- AI Diet Classification Section -->
<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin: 30px 0; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
    <div style="text-align: center; color: white; margin-bottom: 25px;">
        <h2 style="font-size: 28px; margin-bottom: 10px; font-weight: 700;">ü§ñ AI-Powered Diet Classification</h2>
        <p style="font-size: 16px; opacity: 0.9;">Supervised Machine Learning analyzes your eating patterns</p>
        <p style="font-size: 13px; opacity: 0.7; margin-top: 5px;">Analysis based on your last 100 meals</p>
    </div>
    
    <div style="display: flex; gap: 10px; justify-content: center; align-items: center; flex-wrap: wrap;">
        <button id="aiAnalyzeBtn" style="display: flex; align-items: center; justify-content: center; gap: 12px; padding: 18px 30px; font-size: 18px; font-weight: 600; background: white; color: #667eea; border: none; border-radius: 50px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);">
            <span style="font-size: 24px;">üß†</span>
            Analyze My Diet with AI
            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700;">ML Powered</span>
        </button>
        
        <button id="aiRefreshBtn" style="display: none; align-items: center; gap: 8px; padding: 12px 20px; font-size: 14px; font-weight: 600; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 50px; cursor: pointer; transition: all 0.3s ease;">
            <span style="font-size: 18px;">üîÑ</span>
            Refresh Analysis
        </button>
    </div>
    
    <div id="aiClassificationResults" style="margin-top: 30px; background: white; border-radius: 15px; display: none;"></div>
</div>

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

#aiRefreshBtn:hover {
    background: rgba(255,255,255,0.3);
    transform: scale(1.05);
}
</style>

<script>
// AI Classification - Enhanced with refresh capability
document.addEventListener('DOMContentLoaded', function() {
    const aiBtn = document.getElementById('aiAnalyzeBtn');
    const refreshBtn = document.getElementById('aiRefreshBtn');
    
    if (!aiBtn) return;
    
    async function runAIAnalysis() {
        const resultsContainer = document.getElementById('aiClassificationResults');
        const button = aiBtn;
        const originalHTML = button.innerHTML;
        
        button.disabled = true;
        button.innerHTML = '<div style="display: inline-block; width: 20px; height: 20px; border: 3px solid #667eea; border-top: 3px solid transparent; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 10px;"></div> Analyzing...';
        
        resultsContainer.style.display = 'block';
        resultsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px;">
                <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <h3 style="color: #667eea;">üß† AI is analyzing your diet patterns...</h3>
                <p style="color: #666;">Analyzing your last 100 meals using supervised machine learning</p>
            </div>
        `;
        
        try {
            const TOKEN_KEY = typeof CONFIG !== 'undefined' ? CONFIG.STORAGE_KEYS.JWT_TOKEN : 'token';
            const API_URL = typeof CONFIG !== 'undefined' ? CONFIG.API_BASE_URL : 'https://nutrition-advisor-a93q.onrender.com';
            const token = localStorage.getItem(TOKEN_KEY);
            
            if (!token) {
                throw new Error('No authentication token found. Please login again.');
            }
            
            const response = await fetch(`${API_URL}/ai/diet-classification`, {
                method: 'GET',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/json'
                }
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const data = result;
                resultsContainer.innerHTML = `
                    <div style="padding: 25px;">
                        <!-- Last Updated Badge -->
                        <div style="text-align: center; margin-bottom: 15px;">
                            <small style="color: #666; font-size: 12px;">
                                üïê Analysis updated: ${new Date().toLocaleTimeString('en-IN', { hour: '2-digit', minute: '2-digit' })}
                            </small>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 20px;">
                            <span style="background: #667eea; color: white; padding: 8px 20px; border-radius: 20px; font-weight: 600;">
                                üìä ${data.algorithm}
                            </span>
                        </div>
                        
                        <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; color: white; margin-bottom: 25px;">
                            <h3 style="font-size: 32px; margin-bottom: 10px;">üéØ ${data.classification.diet_type}</h3>
                            <div style="display: inline-block; background: rgba(255, 255, 255, 0.3); padding: 8px 20px; border-radius: 25px; font-size: 18px; font-weight: 600;">
                                ${data.classification.confidence}% Confidence
                            </div>
                        </div>
                        
                        <div style="text-align: center; margin: 25px 0;">
                            <h4 style="color: #667eea; margin-bottom: 15px;">Your Health Score</h4>
                            <div style="position: relative; width: 150px; height: 150px; margin: 0 auto;">
                                <svg width="150" height="150" style="transform: rotate(-90deg);">
                                    <circle cx="75" cy="75" r="60" stroke="#e0e0e0" stroke-width="12" fill="none" />
                                    <circle cx="75" cy="75" r="60" stroke="#4CAF50" stroke-width="12" fill="none"
                                            stroke-dasharray="${(data.classification.health_score / 100) * 377} 377" stroke-linecap="round" />
                                </svg>
                                <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 48px; font-weight: 700; color: #667eea;">
                                    ${data.classification.health_score}
                                </div>
                            </div>
                            <p style="color: #666; margin-top: 10px;">out of 100</p>
                        </div>
                        
                        <h4 style="color: #667eea; margin: 25px 0 15px;">üìà Your Nutrition Profile</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 15px;">
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #667eea;">
                                <h4 style="color: #667eea; font-size: 14px; margin-bottom: 8px;">PROTEIN</h4>
                                <div style="font-size: 24px; font-weight: 700;">${data.features.protein_ratio}%</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #4CAF50;">
                                <h4 style="color: #4CAF50; font-size: 14px; margin-bottom: 8px;">CARBS</h4>
                                <div style="font-size: 24px; font-weight: 700;">${data.features.carbs_ratio}%</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #FFC107;">
                                <h4 style="color: #FFC107; font-size: 14px; margin-bottom: 8px;">FAT</h4>
                                <div style="font-size: 24px; font-weight: 700;">${data.features.fat_ratio}%</div>
                            </div>
                            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center; border-left: 4px solid #9C27B0;">
                                <h4 style="color: #9C27B0; font-size: 14px; margin-bottom: 8px;">MEALS</h4>
                                <div style="font-size: 24px; font-weight: 700;">${data.features.total_meals_analyzed}</div>
                            </div>
                        </div>
                        
                        <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 5px solid #ffc107; margin-top: 20px;">
                            <h4 style="color: #856404; margin-bottom: 15px;">üí° AI-Powered Recommendations</h4>
                            ${data.recommendations.map(rec => `
                                <div style="display: flex; gap: 12px; padding: 12px; background: white; border-radius: 8px; margin-bottom: 10px;">
                                    <div style="font-size: 24px;">${rec.substring(0, 2)}</div>
                                    <div style="font-size: 15px; color: #333;">${rec.substring(2)}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                // Show refresh button after first analysis
                refreshBtn.style.display = 'flex';
                
                setTimeout(() => resultsContainer.scrollIntoView({ behavior: 'smooth', block: 'center' }), 100);
            } else {
                resultsContainer.innerHTML = `
                    <div style="background: #fff3cd; padding: 30px; border-radius: 10px; text-align: center;">
                        <h3 style="color: #856404;">‚ö†Ô∏è ${result.error || 'Analysis failed'}</h3>
                        <p style="color: #856404;">${result.current_meals ? `You have ${result.current_meals} meals. Need at least 5 meals.` : 'Please log more meals.'}</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('‚ùå AI Classification Error:', error);
            resultsContainer.innerHTML = `
                <div style="background: #f8d7da; padding: 30px; border-radius: 10px; text-align: center;">
                    <h3 style="color: #721c24;">‚ùå Connection Error</h3>
                    <p style="color: #721c24;">${error.message}</p>
                </div>
            `;
        } finally {
            button.disabled = false;
            button.innerHTML = originalHTML;
        }
    }
    
    // Main analyze button
    aiBtn.addEventListener('click', runAIAnalysis);
    
    // Refresh button
    if (refreshBtn) {
        refreshBtn.addEventListener('click', runAIAnalysis);
    }
});
</script>


<script src="config.js"></script>
  <script src="dashboard-script.js"></script>
</body>
</html>
